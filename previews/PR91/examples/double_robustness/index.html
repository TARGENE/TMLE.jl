<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Model Misspecification &amp; Double Robustness · TMLE.jl</title><meta name="title" content="Model Misspecification &amp; Double Robustness · TMLE.jl"/><meta property="og:title" content="Model Misspecification &amp; Double Robustness · TMLE.jl"/><meta property="twitter:title" content="Model Misspecification &amp; Double Robustness · TMLE.jl"/><meta name="description" content="Documentation for TMLE.jl."/><meta property="og:description" content="Documentation for TMLE.jl."/><meta property="twitter:description" content="Documentation for TMLE.jl."/><meta property="og:url" content="https://TARGENE.github.io/TMLE.jl/examples/double_robustness/"/><meta property="twitter:url" content="https://TARGENE.github.io/TMLE.jl/examples/double_robustness/"/><link rel="canonical" href="https://TARGENE.github.io/TMLE.jl/examples/double_robustness/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/logo.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="TMLE.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">TMLE.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../walk_through/">Walk Through</a></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../../user_guide/scm/">Structural Causal Models</a></li><li><a class="tocitem" href="../../user_guide/estimands/">Estimands</a></li><li><a class="tocitem" href="../../user_guide/estimation/">Estimation</a></li><li><a class="tocitem" href="../../user_guide/misc/">Miscellaneous</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../super_learning/">Becoming a Super Learner</a></li><li class="is-active"><a class="tocitem" href>Model Misspecification &amp; Double Robustness</a><ul class="internal"><li><a class="tocitem" href="#Estimation-using-a-Linear-model"><span>Estimation using a Linear model</span></a></li><li><a class="tocitem" href="#Estimation-using-TMLE"><span>Estimation using TMLE</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../resources/">Resources</a></li><li><a class="tocitem" href="../../api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Model Misspecification &amp; Double Robustness</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Model Misspecification &amp; Double Robustness</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/TARGENE/TMLE.jl/blob/main/examples/double_robustness.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Model-Misspecification-and-Double-Robustness"><a class="docs-heading-anchor" href="#Model-Misspecification-and-Double-Robustness">Model Misspecification &amp; Double Robustness</a><a id="Model-Misspecification-and-Double-Robustness-1"></a><a class="docs-heading-anchor-permalink" href="#Model-Misspecification-and-Double-Robustness" title="Permalink"></a></h1><p>In this example we illustrate the double robustness property of TMLE in the classical backdoor adjustment setting for the Average Treatment Effect.</p><p>Let&#39;s consider the following simple data generating process:</p><p class="math-container">\[\begin{aligned}
W \sim \mathcal{N}(0, 1) \\
T \sim \mathcal{B}(\frac{1}{1 + e^{-(0.3 - 0.5 \cdot W)}}) \\
Y \sim \mathcal{N}(e^{1 - 10 \cdot T + W}, 1)
\end{aligned}\]</p><pre><code class="language-julia hljs">using TMLE
using MLJ
using Distributions
using StableRNGs
using LogExpFunctions
using MLJGLMInterface
using DataFrames
using CairoMakie


μY(T, W) = exp.(1 .- 10T .+ 1W)

function generate_data(;n = 1000, rng = StableRNG(123))
    W  = rand(rng, Normal(), n)
    μT = logistic.(0.3 .- 0.5W)
    T  = float(rand(rng, n) .&lt; μT)
    ϵ = rand(rng, Normal(), n)
    Y  = μY(T, W) .+ ϵ
    Y₁ = μY(ones(n), W) .+ ϵ
    Y₀ = μY(zeros(n), W) .+ ϵ
    return DataFrame(
        W = W,
        T = T,
        Tcat = categorical(T),
        Y = Y,
        Y₁ = Y₁,
        Y₀ = Y₀
    )
end

function plotY(data)
    fig = Figure()
    ax = Axis(fig[1, 1], xlabel=&quot;W&quot;, ylabel=&quot;Y&quot;)
    for (key, group) in pairs(groupby(data, :T))
        scatter!(ax, group.Y, group.W, label=string(&quot;T=&quot;,key.T))
    end
    axislegend()
    return fig
end

data = generate_data(;n = 1000, rng = StableRNG(123))
plotY(data)</code></pre><img src="cbca54a9.png" alt="Example block output"/><p>Y is thus a non linear function of T and W. Despite the simplicity of the example, it is difficult to find a closed form solution for the true Average Causal Effect. However, since we know the generating process, we can approximate it using a Monte-Carlo approximation. In the next two sections, we compare Linear inference and TMLE and see how well they cover this Monte-Carlo approximation.</p><h2 id="Estimation-using-a-Linear-model"><a class="docs-heading-anchor" href="#Estimation-using-a-Linear-model">Estimation using a Linear model</a><a id="Estimation-using-a-Linear-model-1"></a><a class="docs-heading-anchor-permalink" href="#Estimation-using-a-Linear-model" title="Permalink"></a></h2><p>We first propose to estimate the effect size using the classic linear inference method. Because our model does not contain the data generating process (and is hence mis-specified), there is no guarantee that the true effect size will be covered by our confidence interval. In fact, as the sample size grows, the confidence interval will inevitably shrink and fail to cover the ground truth. This can be seen from the following animation:</p><pre><code class="language-julia hljs">function linear_inference(data)
    mach = machine(LinearRegressor(), data[!, [:W, :T]], data.Y)
    fit!(mach, verbosity=0)
    coeftable = report(mach).coef_table
    Trow = findfirst(x -&gt; x == &quot;T&quot;, coeftable.rownms)
    coef = coeftable.cols[1][Trow]
    lb = coeftable.cols[end - 1][Trow]
    ub = coeftable.cols[end][Trow]
    return (coef, lb, ub)
end

function repeat_inference(inference_method; n=1000, K=100)
    estimates = Vector{Float64}(undef, K)
    errors = Vector{Float64}(undef, K)
    mcestimates = Vector{Float64}(undef, K)
    for k in 1:K
        data = generate_data(;n=n, rng=StableRNG(k))
        est, lb, ub = inference_method(data)
        estimates[k] = est
        errors[k] = ub - est
        mcestimates[k] = mean(data.Y₁ .- data.Y₀)
    end
    return estimates, errors, mcestimates
end

function plot_coverage(inference_method; n=1000, K=100)
    fig = Figure()
    title = Observable(string(&quot;N=&quot;, n))
    ax = Axis(fig[1, 1], xlabel=&quot;Repetition&quot;, ylabel=&quot;Estimate size&quot;, title=title)
    ks = 1:K
    estimates, errors, mcestimates = repeat_inference(inference_method; n=n, K=K)
    estimates = Observable(estimates)
    errors = Observable(errors)
    mcestimates = Observable(mcestimates)
    errorbars!(ax, ks, estimates, errors, color=:red, whiskerwidth = 10)
    scatter!(ax, ks, estimates, color=:red, label=replace(string(inference_method), &quot;_&quot; =&gt; &quot; &quot;))
    scatter!(ax, ks, mcestimates, label=&quot;Monte Carlo estimate&quot;)
    axislegend()
    return fig, estimates, errors, mcestimates, title
end

function update_observables!(estimates, errors, mcestimates, title, inference_method; n=1000, K=100)
    newestimates, newerrors, newmcestimates = repeat_inference(inference_method; n=n, K=K)
    estimates[] = newestimates
    errors[] = newerrors
    mcestimates[] = newmcestimates
    title[] = string(&quot;N=&quot;, n)
end

function make_animation(inference_method)
    Ns = [10_000, 25_000, 50_000, 75_000, 100_000, 250_000, 500_000]
    fig, estimates, errors, mcestimates, title = plot_coverage(inference_method; n=10_000, K=100)
    record(fig, &quot;$(inference_method).gif&quot;, Ns; framerate = 1) do n
        update_observables!(estimates, errors, mcestimates, title, inference_method; n=n, K=100)
    end
end

make_animation(linear_inference)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">&quot;linear_inference.gif&quot;</code></pre><p><img src="../linear_inference.gif" alt="Linear Inference"/></p><h2 id="Estimation-using-TMLE"><a class="docs-heading-anchor" href="#Estimation-using-TMLE">Estimation using TMLE</a><a id="Estimation-using-TMLE-1"></a><a class="docs-heading-anchor-permalink" href="#Estimation-using-TMLE" title="Permalink"></a></h2><p>To solve this issue, we will now use TMLE to estimate the Average Treatment Effect. We will keep the mis-specified linear model to estimate <code>E[Y|T,W]</code> but will estimate <code>p(T|W)</code> with a logistic regression which turns out to be the true generating model in this case. Because TMLE is double robust we see that we now have full coverage of the ground truth.</p><pre><code class="language-julia hljs">function tmle_inference(data)
    Ψ = ATE(
        outcome=:Y,
        treatment_values=(Tcat=(case=1.0, control=0.0),),
        treatment_confounders=(Tcat=[:W],)
    )
    models = (Y=with_encoder(LinearRegressor()), Tcat=LinearBinaryClassifier())
    tmle = TMLEE(models=models)
    result, _ = tmle(Ψ, data; verbosity=0)
    lb, ub = confint(OneSampleTTest(result))
    return (TMLE.estimate(result), lb, ub)
end

make_animation(tmle_inference)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">&quot;tmle_inference.gif&quot;</code></pre><p><img src="../tmle_inference.gif" alt="TMLE Inference"/></p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../super_learning/">« Becoming a Super Learner</a><a class="docs-footer-nextpage" href="../../resources/">Resources »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Tuesday 21 November 2023 18:28">Tuesday 21 November 2023</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
