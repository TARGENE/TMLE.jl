<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Case–Control Design and Biased Sampling · TMLE.jl</title><meta name="title" content="Case–Control Design and Biased Sampling · TMLE.jl"/><meta property="og:title" content="Case–Control Design and Biased Sampling · TMLE.jl"/><meta property="twitter:title" content="Case–Control Design and Biased Sampling · TMLE.jl"/><meta name="description" content="Documentation for TMLE.jl."/><meta property="og:description" content="Documentation for TMLE.jl."/><meta property="twitter:description" content="Documentation for TMLE.jl."/><meta property="og:url" content="https://TARGENE.github.io/TMLE.jl/examples/case_control_experiment/"/><meta property="twitter:url" content="https://TARGENE.github.io/TMLE.jl/examples/case_control_experiment/"/><link rel="canonical" href="https://TARGENE.github.io/TMLE.jl/examples/case_control_experiment/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/logo.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="TMLE.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">TMLE.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../walk_through/">Walk Through</a></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../../user_guide/scm/">Structural Causal Models</a></li><li><a class="tocitem" href="../../user_guide/estimands/">Estimands</a></li><li><a class="tocitem" href="../../user_guide/estimation/">Estimators</a></li><li><a class="tocitem" href="../../user_guide/resampling/">Resampling Strategies</a></li><li><a class="tocitem" href="../../user_guide/acceleration/">Accelerations</a></li><li><a class="tocitem" href="../../user_guide/missingness/">Missingness</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../super_learning/">Becoming a Super Learner</a></li><li><a class="tocitem" href="../double_robustness/">Model Misspecification &amp; Double Robustness</a></li><li><a class="tocitem" href="../interactions_correlated/">Interaction Estimation</a></li><li class="is-active"><a class="tocitem" href>Case–Control Design and Biased Sampling</a><ul class="internal"><li><a class="tocitem" href="#Data-Generating-Process"><span>Data Generating Process</span></a></li><li><a class="tocitem" href="#Sampling-Bias"><span>Sampling Bias</span></a></li><li><a class="tocitem" href="#CCW–TMLE-vs-Canonical-TMLE-in-the-Presence-of-Sampling-Bias"><span>CCW–TMLE vs Canonical TMLE in the Presence of Sampling Bias</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../integrations/">Integrations</a></li><li><a class="tocitem" href="../../estimators_cheatsheet/">Estimators&#39; Cheat Sheet</a></li><li><a class="tocitem" href="../../resources/">Learning Resources</a></li><li><a class="tocitem" href="../../api/">API Reference</a></li><li><a class="tocitem" href="../../contributing/">Contributing &amp; Reporting</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Case–Control Design and Biased Sampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Case–Control Design and Biased Sampling</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/TARGENE/TMLE.jl/blob/main/examples/case_control_experiment.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Case–Control-Design-and-Biased-Sampling"><a class="docs-heading-anchor" href="#Case–Control-Design-and-Biased-Sampling">Case–Control Design and Biased Sampling</a><a id="Case–Control-Design-and-Biased-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Case–Control-Design-and-Biased-Sampling" title="Permalink"></a></h1><p>In this example we aim to present a strategy for estimating causal parameters in experiments with biased sampling designs. The most well-known of these designs in practice is the case-control study. Unfortunately, this bias in the sampling mechanism will result in a systematic bias in the associated causal effects. However, the TMLE framework provides a way to adjust for this bias. The main requirement for this adjustment is knowledge of the true population prevalence of the outcome (<span>$q_0$</span>). In TMLE.jl, this can be provided to the <code>Tmle</code> estimator via the <code>prevalence</code> keyword argument. We will call the resulting estimator the CCW-TMLE.</p><h2 id="Data-Generating-Process"><a class="docs-heading-anchor" href="#Data-Generating-Process">Data Generating Process</a><a id="Data-Generating-Process-1"></a><a class="docs-heading-anchor-permalink" href="#Data-Generating-Process" title="Permalink"></a></h2><p>Let&#39;s consider the following structural causal model for our data generating distribution <span>$P₀$</span>, in which there are no unobserved counfounders.</p><p><img src="../../assets/simple_causal_graph.png" alt="simple-causal-graph"/></p><p>Let&#39;s assume the following generating process where the set of confounders <code>W</code> is a binary random variable, <code>T</code> is a binary treatment variable dependent on <code>W</code> and <code>Y</code> is the binary outcome dependent on both <code>T</code> and <code>W</code>.</p><p class="math-container">\[\begin{aligned}
W \sim \mathcal{Bernoulli}(0.5) \\
T \sim \mathcal{B}(\frac{1}{1 + e^{0.2 - 0.8\cdot W}}) \\
Y \sim \mathcal{B}(\frac{1}{1 + e^{3.0 - log(2.0)\cdot T - log(1.5)\cdot W}})
\end{aligned}\]</p><p>And here the observations drawn from <span>$P_0$</span> are denoted as <span>$O = (W, T, Y)$</span>.</p><pre><code class="language-julia hljs">using Random
using DataFrames
using Distributions
using Statistics
using MLJBase
using CategoricalArrays
using CairoMakie
using TMLE

α, β, γ = -3.0, log(2.0), log(1.5)
pA_given_W(w) = 1 / (1 + exp(-(-0.2 + 0.8*w)))
pY_given_A_W(t, w) = 1 / (1 + exp(-(α + β*t + γ*w)))

function generate_population(;n=2_000_000)
    W = rand(Bernoulli(0.5), n)
    A = [rand(Bernoulli(pA_given_W(w))) for w in W]
    Y = [rand(Bernoulli(pY_given_A_W(a, w))) for (a, w) in zip(A, W)]
    return DataFrame(W=W, A=A, Y=Y)
end

Random.seed!(42)

pop = generate_population()

first(pop, 5)</code></pre><div><div style = "float: left;"><span>5×3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">W</th><th style = "text-align: left;">A</th><th style = "text-align: left;">Y</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Bool" style = "text-align: left;">Bool</th><th title = "Bool" style = "text-align: left;">Bool</th><th title = "Bool" style = "text-align: left;">Bool</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">false</td><td style = "text-align: right;">false</td><td style = "text-align: right;">false</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">true</td><td style = "text-align: right;">false</td><td style = "text-align: right;">true</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">true</td><td style = "text-align: right;">true</td><td style = "text-align: right;">false</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: right;">false</td><td style = "text-align: right;">true</td><td style = "text-align: right;">false</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: right;">false</td><td style = "text-align: right;">false</td><td style = "text-align: right;">false</td></tr></tbody></table></div><h2 id="Sampling-Bias"><a class="docs-heading-anchor" href="#Sampling-Bias">Sampling Bias</a><a id="Sampling-Bias-1"></a><a class="docs-heading-anchor-permalink" href="#Sampling-Bias" title="Permalink"></a></h2><p>We then define a biased sampling strategy to simulate a case-control study with case (Y = 1) prevalence of a specified <code>q</code>. As a consequence of this sampling design our observed data distribution P will not be equal to the true population distribution P₀. Instead our experimental unit or set of observations will be represented by the following form: <span>$O = ((W_1, A_1), (W^{j}_0, A^{j}_0):j=1...J) \sim P_0$</span>, where <span>$(W_1, A_1) \sim P₀|Y=1$</span> and <span>$(W^{j}_0, A^{j}_0) \sim P₀|Y=0$</span>.</p><pre><code class="language-julia hljs">function subsample_case_control(
    pop::DataFrame,
    q::Float64;
    n::Int = 100_000,
    outcome_col::Symbol = :Y,
    rng::AbstractRNG = Random.GLOBAL_RNG,
    )
    n_case = round(Int, q * n)
    n_ctl  = n - n_case
    y = pop[!, outcome_col]
    case_idx = findall(y .== 1)
    ctl_idx  = findall(y .== 0)
    sel_cases = shuffle(rng, case_idx)[1:n_case]
    sel_ctls  = shuffle(rng, ctl_idx)[1:n_ctl]
    sample = pop[vcat(sel_cases, sel_ctls), :]
    sample.A = categorical(sample.A)
    sample.Y = categorical(sample.Y)
    return sample
end

subsample_case_control(pop, 0.1; n = 5)</code></pre><div><div style = "float: left;"><span>5×3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">W</th><th style = "text-align: left;">A</th><th style = "text-align: left;">Y</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Bool" style = "text-align: left;">Bool</th><th title = "CategoricalArrays.CategoricalValue{Bool, UInt32}" style = "text-align: left;">Cat…</th><th title = "CategoricalArrays.CategoricalValue{Bool, UInt32}" style = "text-align: left;">Cat…</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">false</td><td style = "text-align: left;">false</td><td style = "text-align: left;">false</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">true</td><td style = "text-align: left;">false</td><td style = "text-align: left;">false</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">false</td><td style = "text-align: left;">true</td><td style = "text-align: left;">false</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: right;">false</td><td style = "text-align: left;">true</td><td style = "text-align: left;">false</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: right;">false</td><td style = "text-align: left;">true</td><td style = "text-align: left;">false</td></tr></tbody></table></div><p>We define a function to estimate the ATE using both the canonical TMLE and CCW-TMLE from the biased sample. Here, the CCW-TMLE is provided with the true population prevalence <code>q₀</code>. With this information, the CCW-TMLE can reconstruct the true population structure in the presence of biased sampling allowing for the estimation of the true population ATE. On the other hand, the canonical TMLE will estimate an ATE that is dependent on the observed population with a biased sturcture.</p><pre><code class="language-julia hljs">function estimate_Ψ(sample::DataFrame, q0::Float64)
    Ψ = ATE(
    outcome = :Y,
    treatment_values = (A=(case=1, control=0),),
    treatment_confounders = (A=[:W],)
    )
    canonical_tmle = Tmle(weighted=false)
    ccw_tmle  = Tmle(prevalence=q0, weighted=false)
    canon_estimate, _ = canonical_tmle(Ψ, sample; verbosity=0)
    ccw_estimate, _   = ccw_tmle(Ψ, sample; verbosity=0)
    return canon_estimate, ccw_estimate
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">estimate_Ψ (generic function with 1 method)</code></pre><h2 id="CCW–TMLE-vs-Canonical-TMLE-in-the-Presence-of-Sampling-Bias"><a class="docs-heading-anchor" href="#CCW–TMLE-vs-Canonical-TMLE-in-the-Presence-of-Sampling-Bias">CCW–TMLE vs Canonical TMLE in the Presence of Sampling Bias</a><a id="CCW–TMLE-vs-Canonical-TMLE-in-the-Presence-of-Sampling-Bias-1"></a><a class="docs-heading-anchor-permalink" href="#CCW–TMLE-vs-Canonical-TMLE-in-the-Presence-of-Sampling-Bias" title="Permalink"></a></h2><p>To illustrate, we select various levels of case-control prevalences <code>q</code> and compare the estimates from both the canonical TMLE and CCW-TMLE. Because we know the true generating process and population, both the true causal effect and prevalence are known.</p><pre><code class="language-julia hljs">q₀ = mean(pop.Y)
W = pop.W
π1 = pY_given_A_W.(1, W)
π0 = pY_given_A_W.(0, W)
true_RD = mean(π1 .- π0)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.0517906420413842</code></pre><p>The following code performs the following operations:</p><ol><li>For each prevalence <code>q</code>, it generates a case-control subsample and estimates the average treatment effect with both the classic TMLE and CCW-TMLE.</li><li>It plots the estimation results.</li></ol><pre><code class="language-julia hljs">function ribbon!(ax, x, y, ylow, yhigh; color, label=nothing)
    band!(ax, x, ylow, yhigh, color=(color, 0.25))
    lines!(ax, x, y, color=color, label=label, linewidth=2)
end

function sampling_bias_analysis(
    pop::DataFrame,
    n::Int,
    sampling_range::Tuple{Float64,Float64},
    n_studies::Int,
    q0::Float64,
    true_Ψ::Float64;
    rng=Random.GLOBAL_RNG
)
    q_min, q_max = sampling_range
    qs = exp.(range(log(q_min), log(q_max), length=n_studies))

    results = DataFrame(q=Float64[],
                        method=String[],
                        estimate=Float64[],
                        lower=Float64[],
                        upper=Float64[])

    for q in qs
        sample = subsample_case_control(pop, q; n=n, rng=rng)
        est_plain, est_ccw = estimate_Ψ(sample, q0)
        ci_plain = confint(significance_test(est_plain))
        ci_ccw   = confint(significance_test(est_ccw))
        push!(results, (q, &quot;TMLE&quot;, est_plain.estimate, ci_plain[1], ci_plain[2]))
        push!(results, (q, &quot;CCW–TMLE&quot;, est_ccw.estimate, ci_ccw[1], ci_ccw[2]))
    end

    fig = Figure(resolution=(800,500))
    ax = Axis(fig[1,1], title=&quot;Sampling Bias: Standard vs CCW–TMLE&quot;,
              xlabel=&quot;Sampling prevalence q&quot;,
              ylabel=&quot;ATE (risk difference)&quot;)
    df_plain = filter(:method =&gt; ==(&quot;TMLE&quot;), results)
    ribbon!(ax, df_plain.q, df_plain.estimate, df_plain.lower, df_plain.upper;
            color=:dodgerblue, label=&quot;Standard TMLE&quot;)
    df_ccw = filter(:method =&gt; ==(&quot;CCW–TMLE&quot;), results)
    ribbon!(ax, df_ccw.q, df_ccw.estimate, df_ccw.lower, df_ccw.upper;
            color=:orange, label=&quot;CCW–TMLE&quot;)
    hlines!(ax, [true_Ψ], color=:black, linestyle=:dash, label=&quot;True ATE&quot;)
    vlines!(ax, [q0], color=:red, linestyle=:dot, label=&quot;True q₀&quot;)
    axislegend(ax, position=:rb)
    return results, fig
end

results, figure = sampling_bias_analysis(pop, 100_000, (0.01, 0.5), 8, q₀, true_RD)
figure</code></pre><img src="a321a365.png" alt="Example block output"/><p>Interpretation:</p><ul><li>Standard TMLE estimates drift as sampling prevalence deviates from q₀ because the empirical distribution over- or under-represents cases.</li><li>CCW–TMLE with the true q₀ remains stable across sampling prevalences.</li></ul><p>This demonstrates how by supplying the true population prevalence we can recover the true population structure in biased (case–control) sampling designs allowing for the estimation of population parameters that are otherwise sampling dependent.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../interactions_correlated/">« Interaction Estimation</a><a class="docs-footer-nextpage" href="../../integrations/">Integrations »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Monday 1 September 2025 11:09">Monday 1 September 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
